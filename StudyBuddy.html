<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เพื่อนติวคู่ใจ</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .toast.error {
      background: #ef4444;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .lesson-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .lesson-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .post-card {
      border-left: 4px solid;
      transition: all 0.2s;
    }
    
    .post-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .image-preview {
      position: relative;
      display: inline-block;
      margin: 8px;
    }
    
    .image-preview img {
      max-width: 150px;
      max-height: 150px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .image-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full"></div>
  <script>
    const defaultConfig = {
      site_title: "เพื่อนติวคู่ใจ",
      welcome_message: "ยินดีต้อนรับสู่เพื่อนติวคู่ใจ",
      primary_color: "#3b82f6",
      secondary_color: "#f3f4f6",
      text_color: "#1f2937",
      card_color: "#ffffff",
      accent_color: "#10b981",
      font_family: "Arial",
      font_size: 16
    };
    
    let appState = {
      currentView: 'login',
      currentUser: null,
      selectedGrade: null,
      selectedSubject: null,
      selectedLesson: null,
      editingPostId: null,
      imageUrls: []
    };
    
    let allPosts = [];
    let allUsers = [];
    
    const gradeSubjects = {
      'ม.1': ['วิทยาศาสตร์', 'คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'สังคม'],
      'ม.2': ['วิทยาศาสตร์', 'คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'สังคม'],
      'ม.3': ['วิทยาศาสตร์', 'คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'สังคม'],
      'ม.4': ['ฟิสิกส์', 'เคมี', 'ชีววิทยา', 'คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'สังคม'],
      'ม.5': ['ฟิสิกส์', 'เคมี', 'ชีววิทยา', 'คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'สังคม'],
      'ม.6': ['ฟิสิกส์', 'เคมี', 'ชีววิทยา', 'คณิตศาสตร์', 'ภาษาไทย', 'ภาษาอังกฤษ', 'สังคม']
    };
    
    const subjectLessons = {
      'วิทยาศาสตร์': ['บทที่ 1: วิธีการทางวิทยาศาสตร์', 'บทที่ 2: สสารและสมบัติ', 'บทที่ 3: การเปลี่ยนแปลงของสสาร', 'บทที่ 4: แรงและการเคลื่อนที่', 'บทที่ 5: พลังงานและการอนุรักษ์'],
      'คณิตศาสตร์': ['บทที่ 1: จำนวนเต็ม', 'บทที่ 2: เศษส่วน', 'บทที่ 3: ทศนิยม', 'บทที่ 4: เรขาคณิต', 'บทที่ 5: สถิติเบื้องต้น'],
      'ภาษาไทย': ['บทที่ 1: การอ่านและการเขียน', 'บทที่ 2: วรรณคดีไทย', 'บทที่ 3: หลักภาษา', 'บทที่ 4: การเขียนเรียงความ', 'บทที่ 5: วรรณกรรม'],
      'ภาษาอังกฤษ': ['Lesson 1: Greetings', 'Lesson 2: Present Tense', 'Lesson 3: Past Tense', 'Lesson 4: Reading Comprehension', 'Lesson 5: Writing Skills'],
      'สังคม': ['บทที่ 1: ประวัติศาสตร์ไทย', 'บทที่ 2: ภูมิศาสตร์', 'บทที่ 3: เศรษฐศาสตร์', 'บทที่ 4: สังคมและวัฒนธรรม', 'บทที่ 5: การเมืองการปกครอง'],
      'ฟิสิกส์': ['บทที่ 1: กลศาสตร์', 'บทที่ 2: พลังงานและงาน', 'บทที่ 3: คลื่นและเสียง', 'บทที่ 4: ไฟฟ้า', 'บทที่ 5: แสงและทัศนศาสตร์'],
      'เคมี': ['บทที่ 1: โครงสร้างอะตอม', 'บทที่ 2: พันธะเคมี', 'บทที่ 3: สารละลาย', 'บทที่ 4: ปฏิกิริยาเคมี', 'บทที่ 5: เคมีอินทรีย์'],
      'ชีววิทยา': ['บทที่ 1: เซลล์และการทำงาน', 'บทที่ 2: พันธุศาสตร์', 'บทที่ 3: วิวัฒนาการ', 'บทที่ 4: นิเวศวิทยา', 'บทที่ 5: ระบบในร่างกาย']
    };
    
    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    async function handleRegister(e) {
      e.preventDefault();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      
      if (!username || !password) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', true);
        return;
      }
      
      if (password.length < 4) {
        showToast('รหัสผ่านต้องมีอย่างน้อย 4 หลัก', true);
        return;
      }
      
      const existingUser = allUsers.find(u => u.username === username);
      if (existingUser) {
        showToast('ชื่อผู้ใช้นี้มีอยู่แล้ว', true);
        return;
      }
      
      const loadingBtn = e.target.querySelector('button[type="submit"]');
      loadingBtn.disabled = true;
      loadingBtn.textContent = 'กำลังสมัคร...';
      
      const result = await window.dataSdk.create({
        id: `user_${Date.now()}_${Math.random()}`,
        username: username,
        password: password,
        post_id: '',
        author: '',
        grade: '',
        subject: '',
        lesson: '',
        content: '',
        image_urls: '',
        created_at: new Date().toISOString(),
        updated_at: ''
      });
      
      loadingBtn.disabled = false;
      loadingBtn.textContent = 'สมัครสมาชิก';
      
      if (result.isOk) {
        showToast('สมัครสมาชิกสำเร็จ');
        document.getElementById('reg-username').value = '';
        document.getElementById('reg-password').value = '';
      } else {
        showToast('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', true);
      }
    }
    
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      
      if (!username || !password) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', true);
        return;
      }
      
      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        appState.currentUser = username;
        appState.currentView = 'grades';
        render();
        showToast('เข้าสู่ระบบสำเร็จ');
      } else {
        showToast('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', true);
      }
    }
    
    function selectGrade(grade) {
      appState.selectedGrade = grade;
      appState.currentView = 'subjects';
      render();
    }
    
    function selectSubject(subject) {
      appState.selectedSubject = subject;
      appState.currentView = 'lessons';
      render();
    }
    
    function selectLesson(lesson) {
      appState.selectedLesson = lesson;
      appState.currentView = 'posts';
      appState.editingPostId = null;
      appState.imageUrls = [];
      render();
    }
    
    function handleImageInput(e) {
      const input = e.target;
      const files = Array.from(input.files);
      
      if (files.length > 5) {
        showToast('สามารถแนบรูปภาพได้สูงสุด 5 รูป', true);
        input.value = '';
        return;
      }
      
      files.forEach(file => {
        if (appState.imageUrls.length >= 5) {
          showToast('สามารถแนบรูปภาพได้สูงสุด 5 รูป', true);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          appState.imageUrls.push(event.target.result);
          renderImagePreviews();
        };
        reader.readAsDataURL(file);
      });
      
      input.value = '';
    }
    
    function removeImage(index) {
      appState.imageUrls.splice(index, 1);
      renderImagePreviews();
    }
    
    function renderImagePreviews() {
      const container = document.getElementById('image-previews');
      if (!container) return;
      
      container.innerHTML = '';
      appState.imageUrls.forEach((url, index) => {
        const preview = document.createElement('div');
        preview.className = 'image-preview';
        preview.innerHTML = `
          <img src="${url}" alt="Preview ${index + 1}">
          <div class="image-remove" onclick="removeImage(${index})">×</div>
        `;
        container.appendChild(preview);
      });
    }
    
    async function handlePostSubmit(e) {
      e.preventDefault();
      const content = document.getElementById('post-content').value.trim();
      
      if (!content && appState.imageUrls.length === 0) {
        showToast('กรุณาเพิ่มเนื้อหาหรือรูปภาพ', true);
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'กำลังบันทึก...';
      
      if (appState.editingPostId) {
        const postToEdit = allPosts.find(p => p.post_id === appState.editingPostId);
        if (postToEdit) {
          postToEdit.content = content;
          postToEdit.image_urls = appState.imageUrls.join('|||');
          postToEdit.updated_at = new Date().toISOString();
          
          const result = await window.dataSdk.update(postToEdit);
          
          submitBtn.disabled = false;
          submitBtn.textContent = 'บันทึก';
          
          if (result.isOk) {
            showToast('แก้ไขโพสต์สำเร็จ');
            appState.editingPostId = null;
            appState.imageUrls = [];
            document.getElementById('post-content').value =
